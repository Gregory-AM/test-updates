name: Notify Discord on Release

on:
  release:
    types: [published]

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Release Info
        id: get_release_info
        run: |
          echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "release_name=${{ github.event.release.name }}" >> $GITHUB_OUTPUT
          echo "release_url=${{ github.event.release.html_url }}" >> $GITHUB_OUTPUT
          echo "published_at=${{ github.event.release.published_at }}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${{ github.event.release.prerelease }}" >> $GITHUB_OUTPUT

          # Process release body - convert to JSON string
          BODY='${{ github.event.release.body }}'
          CLEAN_BODY=$(echo "$BODY" | jq -Rs)
          echo "clean_body=$CLEAN_BODY" >> $GITHUB_OUTPUT

      - name: Determine Update Type
        id: detect_type
        run: |
          tag="${{ steps.get_release_info.outputs.tag_name }}"
          is_prerelease="${{ steps.get_release_info.outputs.is_prerelease }}"
          version="${tag#v}"

          # Parse version components
          IFS='.-' read -ra PARTS <<< "$version"
          major="${PARTS[0]}"
          minor="${PARTS[1]}"
          patch="${PARTS[2]}"

          type="PATCH"

          if [[ "$tag" == "v3.0.0" ]]; then
            type="INITIAL"
          elif [[ "$is_prerelease" == "true" || "$version" == *"rc"* || "$version" == *"beta"* ]]; then
            type="PRERELEASE"
          else
            if [[ "$minor" == "0" && "$patch" == "0" ]]; then
              type="MAJOR"
            elif [[ "$patch" == "0" ]]; then
              type="MINOR"
            fi
          fi

          echo "type=$type" >> $GITHUB_OUTPUT

      - name: Send Initial Release Notification
        if: steps.detect_type.outputs.type == 'INITIAL'
        uses: fjogeleit/http-request-action@v1.14.1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK }}
          method: POST
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "embeds": [
                {
                  "color": 7308441,
                  "title": "üöÄ INITIAL RELEASE - [Re]Structure v3.0.0",
                  "description": "This is the initial release for the [Re]Structure plugin.",
                  "footer": {
                    "text": "Released",
                    "icon_url": "https://cdn.discordapp.com/avatars/1368444615224459274/e3ebe26579536ab912c23528f67f3281.webp?size=80"
                  },
                  "timestamp": "${{ steps.get_release_info.outputs.published_at }}",
                  "url": "${{ steps.get_release_info.outputs.release_url }}",
                  "fields": [
                    {
                      "name": "RELEASE NOTES:",
                      "value": ${{ steps.get_release_info.outputs.clean_body }}
                    }
                  ]
                }
              ]
            }

      - name: Send Pre-release Notification
        if: steps.detect_type.outputs.type == 'PRERELEASE'
        uses: fjogeleit/http-request-action@v1.14.1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK }}
          method: POST
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "embeds": [
                {
                  "title": "üß™ PRE-RELEASE - ${{ steps.get_release_info.outputs.release_name }}",
                  "description": "This release is for testing and bug hunting.\n\n**Do NOT use in main workspace!**\n\nReport bugs [here](https://github.com/GregoryAM-SP/ReStructure-Plugin/issues).",
                  "url": "${{ steps.get_release_info.outputs.release_url }}",
                  "timestamp": "${{ steps.get_release_info.outputs.published_at }}",
                  "color": 16760124,
                  "footer": {
                    "text": "Pre-release",
                    "icon_url": "https://cdn.discordapp.com/avatars/1368444615224459274/e3ebe26579536ab912c23528f67f3281.webp?size=80"
                  },
                  "author": {
                    "name": "GitHub: @Gregory-AM",
                    "icon_url": "https://avatars.githubusercontent.com/u/83489100?v=4&size=64"
                  },
                  "fields": [
                    {
                      "name": "RELEASE NOTES:",
                      "value": ${{ steps.get_release_info.outputs.clean_body }}
                    }
                  ]
                }
              ]
            }

      - name: Send Release Candidate Notification
        if: contains(steps.get_release_info.outputs.tag_name, 'rc')
        uses: fjogeleit/http-request-action@v1.14.1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK }}
          method: POST
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "embeds": [
                {
                  "title": "üîç RELEASE CANDIDATE - ${{ steps.get_release_info.outputs.release_name }}",
                  "description": "**Release candidates _can be_ used for production use.**\nThis release is for final checks before stable release.\n\nYou can report issues [here](https://github.com/GregoryAM-SP/ReStructure-Plugin/issues).",
                  "url": "${{ steps.get_release_info.outputs.release_url }}",
                  "timestamp": "${{ steps.get_release_info.outputs.published_at }}",
                  "color": 16760124,
                  "footer": {
                    "text": "Release Candidate",
                    "icon_url": "https://cdn.discordapp.com/avatars/1368444615224459274/e3ebe26579536ab912c23528f67f3281.webp?size=80"
                  },
                  "author": {
                    "name": "GitHub: @Gregory-AM",
                    "icon_url": "https://avatars.githubusercontent.com/u/83489100?v=4&size=64"
                  },
                  "fields": [
                    {
                      "name": "RELEASE NOTES:",
                      "value": ${{ steps.get_release_info.outputs.clean_body }}
                    }
                  ]
                }
              ]
            }

      - name: Send Major Update Notification
        if: steps.detect_type.outputs.type == 'MAJOR'
        uses: fjogeleit/http-request-action@v1.14.1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK }}
          method: POST
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "embeds": [
                {
                  "title": "üéâ MAJOR UPDATE - ${{ steps.get_release_info.outputs.release_name }}",
                  "description": "## Major update\n\nThis is the latest stable release of **[Re]Structure**.",
                  "url": "${{ steps.get_release_info.outputs.release_url }}",
                  "timestamp": "${{ steps.get_release_info.outputs.published_at }}",
                  "color": 7929683,
                  "footer": {
                    "text": "Major",
                    "icon_url": "https://cdn.discordapp.com/avatars/1368444615224459274/e3ebe26579536ab912c23528f67f3281.webp?size=80"
                  },
                  "author": {
                    "name": "GitHub: @Gregory-AM",
                    "icon_url": "https://avatars.githubusercontent.com/u/83489100?v=4&size=64"
                  },
                  "fields": [
                    {
                      "name": "BUG REPORTING:",
                      "value": "Report bugs [here](https://github.com/GregoryAM-SP/ReStructure-Plugin/issues)."
                    },
                    {
                      "name": "RELEASE NOTES:",
                      "value": ${{ steps.get_release_info.outputs.clean_body }}
                    }
                  ]
                }
              ]
            }

      - name: Send Minor Update Notification
        if: steps.detect_type.outputs.type == 'MINOR'
        uses: fjogeleit/http-request-action@v1.14.1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK }}
          method: POST
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "embeds": [
                {
                  "title": "‚ú® MINOR UPDATE - ${{ steps.get_release_info.outputs.release_name }}",
                  "description": "## Minor update\n\nLatest stable release.",
                  "url": "${{ steps.get_release_info.outputs.release_url }}",
                  "timestamp": "${{ steps.get_release_info.outputs.published_at }}",
                  "color": 7929683,
                  "footer": {
                    "text": "Minor",
                    "icon_url": "https://cdn.discordapp.com/avatars/1368444615224459274/e3ebe26579536ab912c23528f67f3281.webp?size=80"
                  },
                  "author": {
                    "name": "GitHub: @Gregory-AM",
                    "icon_url": "https://avatars.githubusercontent.com/u/83489100?v=4&size=64"
                  },
                  "fields": [
                    {
                      "name": "RELEASE NOTES:",
                      "value": ${{ steps.get_release_info.outputs.clean_body }}
                    }
                  ]
                }
              ]
            }

      - name: Send Patch Update Notification
        if: steps.detect_type.outputs.type == 'PATCH'
        uses: fjogeleit/http-request-action@v1.14.1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK }}
          method: POST
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "embeds": [
                {
                  "title": "üîß PATCH UPDATE - ${{ steps.get_release_info.outputs.release_name }}",
                  "description": "Patch update released.",
                  "url": "${{ steps.get_release_info.outputs.release_url }}",
                  "timestamp": "${{ steps.get_release_info.outputs.published_at }}",
                  "color": 3323461,
                  "footer": {
                    "text": "Patch",
                    "icon_url": "https://cdn.discordapp.com/avatars/1368444615224459274/e3ebe26579536ab912c23528f67f3281.webp?size=80"
                  },
                  "author": {
                    "name": "GitHub: @Gregory-AM",
                    "icon_url": "https://avatars.githubusercontent.com/u/83489100?v=4&size=64"
                  },
                  "fields": [
                    {
                      "name": "RELEASE NOTES:",
                      "value": ${{ steps.get_release_info.outputs.clean_body }}
                    }
                  ]
                }
              ]
            }
