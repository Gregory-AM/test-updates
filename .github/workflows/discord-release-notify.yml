name: "Notify Discord on Release & Prerelease"

on:
  release:
    types: [published, prereleased]

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Extract Release Info
        id: get_release_info
        run: |
          echo "tag_name=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${{ github.event.release.prerelease }}" >> $GITHUB_OUTPUT

      - name: Determine Update Type
        id: detect_type
        run: |
          tag="${{ steps.get_release_info.outputs.tag_name }}"
          is_prerelease="${{ steps.get_release_info.outputs.is_prerelease }}"

          version="${tag#v}"
          IFS='.-' read -ra PARTS <<< "$version"
          major="${PARTS[0]}"
          minor="${PARTS[1]}"
          patch="${PARTS[2]}"

          type="PATCH"

          if [[ "$is_prerelease" == "true" || "$version" == *"rc"* ]]; then
            type="RC"
          else
            if [[ "$minor" == "0" && "$patch" == "0" ]]; then
              type="MAJOR"
            elif [[ "$patch" == "0" ]]; then
              type="MINOR"
            fi
          fi

          echo "type=$type" >> $GITHUB_OUTPUT

      # PATCH
      - name: Send PATCH Update Notification
        if: ${{ steps.detect_type.outputs.type == 'PATCH' }}
        uses: fjogeleit/http-request-action@v1.14.1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          method: POST
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "content": "<@&1368448364865126491>",
              "embeds": [
                {
                  "title": "NEW PATCH UPDATE - [Re]Structure ${{ github.event.release.tag_name }}",
                  "description": "[Re]Structure has a patch update.\n\nYou can download the update via the [Re]Structure Menu.\nAlternatively, you can download it on [GitHub Releases](${{ github.event.release.html_url }}).",
                  "color": 3323461,
                  "author": {
                    "name": "GregoryAM"
                  },
                  "footer": {
                    "text": "PATCH"
                  },
                  "timestamp": "${{ github.event.release.published_at }}"
                }
              ],
              "attachments": []
            }

      # MINOR
      - name: Send MINOR Update Notification
        if: ${{ steps.detect_type.outputs.type == 'MINOR' }}
        uses: fjogeleit/http-request-action@v1.14.1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          method: POST
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "content": "<@&1368448364865126491>",
              "embeds": [
                {
                  "title": "NEW MINOR UPDATE - [Re]Structure ${{ github.event.release.tag_name }}",
                  "description": "[Re]Structure has a minor update.\n\nYou can download the update via the [Re]Structure Menu.\nAlternatively, you can download it on [GitHub Releases](${{ github.event.release.html_url }}).",
                  "color": 3323461,
                  "author": {
                    "name": "GregoryAM"
                  },
                  "footer": {
                    "text": "MINOR"
                  },
                  "timestamp": "${{ github.event.release.published_at }}"
                }
              ],
              "attachments": []
            }

      # MAJOR
      - name: Send MAJOR Update Notification
        if: ${{ steps.detect_type.outputs.type == 'MAJOR' }}
        uses: fjogeleit/http-request-action@v1.14.1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          method: POST
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "content": "<@&1368448364865126491>",
              "embeds": [
                {
                  "title": "NEW MAJOR UPDATE - [Re]Structure ${{ github.event.release.tag_name }}",
                  "description": "[Re]Structure has a major update.\n\nYou can download the update via the [Re]Structure Menu.\nAlternatively, you can download it on [GitHub Releases](${{ github.event.release.html_url }}).",
                  "color": 3323461,
                  "author": {
                    "name": "GregoryAM"
                  },
                  "footer": {
                    "text": "MAJOR"
                  },
                  "timestamp": "${{ github.event.release.published_at }}"
                }
              ],
              "attachments": []
            }

      # RC (Release Candidate)
      - name: Send RC Update Notification
        if: ${{ steps.detect_type.outputs.type == 'RC' }}
        uses: fjogeleit/http-request-action@v1.14.1
        with:
          url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          method: POST
          customHeaders: '{"Content-Type": "application/json"}'
          data: |
            {
              "content": "<@&1368457457659019304>",
              "embeds": [
                {
                  "title": "NEW RELEASE CANDIDATE - [Re]Structure ${{ github.event.release.tag_name }}",
                  "description": "[Re]Structure has a new release candidate.\n\nYou can download the release-candidate on [GitHub Releases](${{ github.event.release.html_url }}).",
                  "color": 10381827,
                  "author": {
                    "name": "GregoryAM"
                  },
                  "footer": {
                    "text": "RELEASE CANDIDATE"
                  },
                  "timestamp": "${{ github.event.release.published_at }}"
                }
              ],
              "attachments": []
            }
